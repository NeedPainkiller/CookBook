# TCP/IP

## IP 프로토콜

- IP 프로토콜은 인터넷 프로토콜의 기초가 되는 프로토콜이다.
- 특정 IP 주소에 데이터를 전달하기 위한 프로토콜이며 Packet 단위로 데이터를 전달한다.
- 패킷에는 요청자 IP, 수신자 IP, 데이터 등의 정보를 포함한다.

### 한계
- 대상 서버가 패킷을 받을 수 있는 상태인지 알 수 없다
  - 대상 서버가 다운되어 있거나, 네트워크가 끊겨있는 경우에도 패킷을 전송한다. 
- 패킷이 중간에 손실되었을 때, 재전송을 할 수 없다
- 패킷이 순서대로 도착하지 않을 수 있다
- 같은 IP 에서 여러 Application 이 동작할 때, 어떤 Application 으로 전달해야 하는지 알 수 없다

## TCP 프로토콜
- IP 프로토콜의 한계를 극복하기 위해 만들어진 전송 제어 프로토콜이다.
- IP 프로토콜 위에서 동작하는 프로토콜로, 데이터를 전달하기 위한 프로토콜이다.
- 연결 지향적이며, 신뢰성 있는 프로토콜이다.
- 패킷을 전송하기 전에 3-way-handshake 를 통해 연결을 설정하고, 패킷을 전송한 후에는 연결을 해제한다.
- IP 패킷에는 없는 `Port`, `Sequence Number`, `Acknowledgement Number` 등의 정보를 포함한다. 이를 TCP 세그먼트라고 한다.

## TCP 3-way-handshake 
- TCP 연결을 설정하기 위한 과정이다.
- 연결 지향적인 특성을 가지고 있기 때문에, 연결을 설정하기 위해 3번의 통신을 한다.
- 데이터 전달을 보증하고 순서를 보장하기 위해 사용한다.

- 두가지 주요 메시지를 사용한다.
  - SYN : 연결 요청
  - ACK : 응답
- 3-way-handshake 과정
  1. Client -> Server : SYN
  2. Server -> Client : SYN + ACK
  3. Client -> Server : ACK

- 3-way-handshake 과정을 통해 서로간에 연결이 설정되고, 데이터 전송이 가능해진다.
- 하지만 이는 연결이 가능함을 가상으로 보장하는 것이며, 실제 데이터 전송 중에도 문제가 발생할 수 있다.


## TCP 4-way Handshaking
- TCP 연결을 해제하기 위한 과정이다.
- 연결을 해제하기 위해 4번의 통신을 한다.

- 4-way-handshaking 과정
  1. Client -> Server : FIN
  2. Server -> Client : ACK (CLOSE_WAIT 상태로 전환, 데이터 처리, 전송이 완료되면 FIN 전송)
  3. Server -> Client : FIN
  4. Client -> Server : ACK (TIME_WAIT 상태로 전환, timewait  시간 후에 연결 해제)

### timewait 상태
- time_wait 에 있는 동안에는 OS 커널이 IP 주소와 PORT 바인딩하고 있으며 해당 주소로 들어오는 패킷을 버린다.
- timewait 시간이 지나면 해당 주소와 포트를 재사용할 수 있다.
- 네트워크 상의 문제로 클라이언트가 ACK 를 보내주지 못하는 경우가 발생 할 가능성을 대비하여 서버가 다시 FIN 을 보내서 클라이언트로부터 ACK 를 확실히 응답받을 때 까지 기다리는 시간이다.
- 함부로 연결을 해제하지 않고, 데이터가 제대로 전달되었는지 확인하기 위한 시간이다.